---
title: "FutureTech Sales Acceleration Analytics Case"
format:
  dashboard:
    nav-buttons: [github]
    github: https://github.com/pmmagusiak/az_futuretech_case
server: shiny
---

```{r}
#| label: load-packages
#| context: setup
#| message: false

library(tidyverse)
library(skimr)
library(shiny)
```

```{r}
#| label: load-data
#| context: setup
#| message: false

# Importing files into R environment

outreaches <- read_csv("data/contact_summary.csv")

sales <- read_csv("data/sales_summary.csv")
```

```{r}
#| label: initial-prep-data
#| context: setup
#| include: false
#| message: false

## Focusing on outreaches database

skim_without_charts(outreaches) # Using skimr package to summary data tables and overview missing values, duplicates and other information

outreaches |> filter(if_any(everything(), is.null)) # Checking if there are any rows with null values, as skimr does not assess that

outreaches |> 
  count(shop, Product, date) |> 
  filter(n > 1) # There were cases of more than 1 contact per day
  
outreaches_processed <- outreaches |>
  group_by(shop, Product, date) |> 
  mutate(contact_count = n()) |> # Column with a number of contacts per date
  ungroup() |> 
  arrange(date) |> 
  group_by(shop, Product) |> 
  mutate(first_contact = min(date), contact_window_start = date, contact_window_end = lead(date) - days(1)) |> # As there are sales that took place before first contact, a first contact column may prove useful
  mutate(contact_window_end = case_when(is.na(contact_window_end) ~ today(), TRUE ~ contact_window_end)) # Creating contact windows columns is crucial for further sales analysis
  
## Focusing on sales database, initial procedures the same as above

skim_without_charts(sales)

sales |> filter(if_any(everything(), is.null))

## Joining 

sales_before_first_contact <- sales |> 
  inner_join(outreaches_processed, join_by(shop, Product), suffix = c("_of_sell", "_of_previous_contact"), relationship = "many-to-many") |> 
  group_by(shop, Product) |> 
  filter(date_of_sell < first_contact & contact_window_start == first_contact) |> 
  mutate(date_of_previous_contact = NA_Date_, contact_window_start = NA_Date_, contact_window_end = NA_Date_, trigger = NA) # There were 408 cases of items sold before first contact

sales_within_contact_window <- sales |> 
  inner_join(outreaches_processed, join_by(shop, Product), suffix = c("_of_sell", "_of_previous_contact"), relationship = "many-to-many") |> 
  group_by(shop, Product) |> 
  filter(date_of_sell >= contact_window_start & date_of_sell <= contact_window_end)  # Joining variables are shop and product, as there are the same amount of n_unique shop ids and product names in both dbases and shops are in center of my analysis; join type does not matter right now because of many-to-many relationship
  
futuretech <- sales_within_contact_window |> 
  bind_rows(sales_before_first_contact) |> 
  select(shop, product = Product, date_of_sell, units_sold, date_of_previous_contact, contact_count, first_contact, trigger) # Final database after wrangling and column tidying

# My final database has about 60 observations less than raw database because it does not contain information about outreaches that took place after the last sell
```

```{r}
#| label: data-analysis
#| context: setup
#| include: false
#| message: false
```

